import pandas as pd
import numpy as np
import asyncio
import logging
from typing import Dict, List, Optional, Tuple
from datetime import datetime, timedelta
import talib

class MarketDataProcessor:
    def __init__(self, lookback_period: int = 100):
        self.lookback_period = lookback_period
        self.price_data = {}
        self.indicators = {}
        self.logger = logging.getLogger(__name__)
    
    def add_tick_data(self, symbol: str, tick_data: Dict):
        """Add new tick data and update indicators"""
        if symbol not in self.price_data:
            self.price_data[symbol] = []
        
        # Add new tick
        self.price_data[symbol].append({
            'timestamp': datetime.now(),
            'price': float(tick_data['quote']),
            'symbol': symbol
        })
        
        # Keep only recent data
        if len(self.price_data[symbol]) > self.lookback_period:
            self.price_data[symbol] = self.price_data[symbol][-self.lookback_period:]
        
        # Update indicators
        self._update_indicators(symbol)
    
    def _update_indicators(self, symbol: str):
        """Calculate technical indicators"""
        if symbol not in self.price_data or len(self.price_data[symbol]) < 20:
            return
        
        prices = np.array([tick['price'] for tick in self.price_data[symbol]])
        
        # RSI
        rsi = talib.RSI(prices, timeperiod=14)
        
        # MACD
        macd, macd_signal, macd_hist = talib.MACD(prices)
        
        # Bollinger Bands
        bb_upper, bb_middle, bb_lower = talib.BBANDS(prices, timeperiod=20)
        
        # Moving Averages
        sma_20 = talib.SMA(prices, timeperiod=20)
        sma_50 = talib.SMA(prices, timeperiod=50)
        
        # Volatility (ATR approximation)
        high = np.maximum.accumulate(prices)
        low = np.minimum.accumulate(prices)
        tr = np.maximum(high - low, np.abs(np.diff(prices, prepend=prices[0])))
        atr = talib.SMA(tr, timeperiod=14)
        
        self.indicators[symbol] = {
            'current_price': prices[-1],
            'rsi': rsi[-1] if not np.isnan(rsi[-1]) else 50,
            'macd': macd[-1] if not np.isnan(macd[-1]) else 0,
            'macd_signal': macd_signal[-1] if not np.isnan(macd_signal[-1]) else 0,
            'macd_histogram': macd_hist[-1] if not np.isnan(macd_hist[-1]) else 0,
            'bb_upper': bb_upper[-1] if not np.isnan(bb_upper[-1]) else prices[-1],
            'bb_lower': bb_lower[-1] if not np.isnan(bb_lower[-1]) else prices[-1],
            'bb_middle': bb_middle[-1] if not np.isnan(bb_middle[-1]) else prices[-1],
            'sma_20': sma_20[-1] if not np.isnan(sma_20[-1]) else prices[-1],
            'sma_50': sma_50[-1] if not np.isnan(sma_50[-1]) else prices[-1],
            'atr': atr[-1] if not np.isnan(atr[-1]) else 0,
            'volatility': np.std(prices[-20:]) if len(prices) >= 20 else 0,
            'trend': 'up' if sma_20[-1] > sma_50[-1] else 'down'
        }
    
    def get_market_regime(self, symbol: str) -> str:
        """Determine current market regime"""
        if symbol not in self.indicators:
            return "neutral"
        
        indicators = self.indicators[symbol]
        volatility = indicators['volatility']
        rsi = indicators['rsi']
        
        if volatility > np.mean(list(self.indicators.values())[0]['volatility'] * 1.5):
            return "high_volatility"
        elif 30 < rsi < 70:
            return "ranging"
        else:
            return "trending"
    
    def get_trading_signals(self, symbol: str) -> Dict[str, float]:
        """Generate trading signals based on indicators"""
        if symbol not in self.indicators:
            return {}
        
        ind = self.indicators[symbol]
        signals = {}
        
        # RSI signals
        if ind['rsi'] < 30:
            signals['rsi_oversold'] = 0.8
        elif ind['rsi'] > 70:
            signals['rsi_overbought'] = 0.8
        
        # MACD signals
        if ind['macd'] > ind['macd_signal'] and ind['macd_histogram'] > 0:
            signals['macd_bullish'] = 0.7
        elif ind['macd'] < ind['macd_signal'] and ind['macd_histogram'] < 0:
            signals['macd_bearish'] = 0.7
        
        # Bollinger Bands signals
        price = ind['current_price']
        if price < ind['bb_lower']:
            signals['bb_oversold'] = 0.6
        elif price > ind['bb_upper']:
            signals['bb_overbought'] = 0.6
        
        # Trend signals
        if ind['trend'] == 'up':
            signals['trend_bullish'] = 0.5
        else:
            signals['trend_bearish'] = 0.5
        
        return signals
